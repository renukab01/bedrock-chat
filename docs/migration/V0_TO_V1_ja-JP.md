# マイグレーションガイド (v0 から v1)

すでに以前のバージョン（〜`0.4.x`）の Bedrock Chat を使用している場合は、以下の手順に従ってマイグレーションする必要があります。

## なぜ行う必要があるのか？

このメジャーアップデートには、重要なセキュリティ更新が含まれています。

- ベクターデータベース（Aurora PostgreSQLの pgvector）のストレージが現在暗号化されており、デプロイ時に置き換えが発生します。これは、既存のベクターアイテムが削除されることを意味します。
- ボット作成が可能なユーザーを制限するために、`CreatingBotAllowed` Cognitoユーザーグループを導入しました。既存のユーザーはデフォルトでこのグループに属していないため、ボット作成の権限を持たせたい場合は、手動で権限をアタッチする必要があります。詳細は: [ボットのパーソナライズ](../../README.md#bot-personalization)

## 前提条件

[データベース移行ガイド](./DATABASE_MIGRATION_ja-JP.md)を読み、アイテムの復元方法を決定してください。

## 手順

### ベクターストア移行

- ターミナルを開き、プロジェクトディレクトリに移動します
- デプロイしたいブランチをプルします。以下は目的のブランチ（この場合は `v1`）にチェックアウトし、最新の変更をプルします：

```sh
git fetch
git checkout v1
git pull origin v1
```

- DMSでアイテムを復元する場合、パスワードのローテーションを無効にし、データベースにアクセスするためのパスワードを必ず控えてください。移行スクリプト([migrate_v0_v1.py](./migrate_v0_v1.py))で復元する場合は、パスワードを控える必要はありません。
- CloudFormationが既存のAuroraクラスターを削除できるように、すべての[公開されたAPI](../PUBLISH_API_ja-JP.md)を削除します。
- [npx cdk deploy](../README.md#deploy-using-cdk)を実行し、Auroraクラスターの置き換えをトリガーし、すべてのベクターアイテムを削除します。
- [データベース移行ガイド](./DATABASE_MIGRATION_ja-JP.md)に従って、ベクターアイテムを復元します。
- ユーザーが既存のボット（つまり、RAGボット）を利用できることを確認します。

### CreatingBotAllowed権限の付与

- デプロイ後、すべてのユーザーは新しいボットを作成できなくなります。
- 特定のユーザーにボットの作成を許可する場合は、管理コンソールまたはCLIを使用して、それらのユーザーを `CreatingBotAllowed` グループに追加します。
- ユーザーがボットを作成できるかどうかを確認します。ユーザーは再ログインする必要があることに注意してください。